<!DOCTYPE html>
<html>
<head>
    <title>unkm.fr</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
    <style>
        body { padding: 0; margin: 0; font-family: 'Roboto', arial, 'Segoe UI', 'Roboto', arial, system-ui, BlinkMacSystemFont, 'Roboto', arial, sans-serif; }
        html, body, #map { height: 100%; width: 100%; }
        h4 { padding: 5px; margin: 5px; }
        #info { position: fixed; z-index: 1000; top: 50%; left: 50%; margin-top: -80px; margin-left: -250px; height: 160px; width: 500px; text-align: center; border: 3px solid #f07300; background-color: white; font-size: 20px; cursor: pointer; }
        #help { position: fixed; z-index: 1000; bottom: 10px; left: 10px; height: 50px; width: 50px; text-align: center; border-radius: 50%; background-color: #f07300; font-size: 20px; cursor: pointer; }
        #help > p { margin: 10px; font-size: 22px; font-weight: bolder; color: white; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="help"><p>?</p></div>
    <div id="info">
      <h4>Comment ça marche ?</h4>
      Zoomez sur votre lieu de confinement<br />
      Cliquez pour dessiner un cercle de 1km de rayon<br /><br />
      Vous pouvez aussi vous <button id="gelocation">géolocaliser</button>
    </div>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script>
      var map = L.map('map').setView([46.71109, 1.7191036], 6);
      mapLink = '<a href="https://openstreetmap.org">OpenStreetMap</a>';
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Map data &copy; ' + mapLink, maxZoom: 18}).addTo(map);

      map.on('click', helpHide);
      map.on('movestart', helpHide);
      map.on('zoomstart', helpHide);
      document.getElementById("info").onclick = helpHide;
      document.getElementById("help").onclick = helpDisplay;
      document.getElementById("gelocation").onclick = geolocationRequest;

      function locationUpdate(e) {
        if(e) {
          if(map.getZoom() < 12) {return;};
          window.location.hash = e.latlng.lat+','+e.latlng.lng;
        }
        if(typeof window.location.hash != "undefined" && window.location.hash.length > 5) {
          hashpos = window.location.hash.substring(1).split(',')
          var event = {latlng: L.latLng(hashpos[0], hashpos[1])}
          map.setView(event.latlng, 15);
          displayCircle(event);
          helpHide();
        }
      }
      window.onhashchange = locationUpdate();
      locationUpdate();

      function helpHide(e) {
        document.getElementById("info").style.display = "none";
        map.on('click', locationUpdate);
      }

      function helpDisplay(e) {
        document.getElementById("info").style.display = "block";
      }

      function geolocationRequest() {
        map.locate({setView: true, maxZoom: 15, enableHighAccuracy: true});
        map.on('locationfound', geolocationFound);
      }

      function geolocationFound(e) {
        locationUpdate(e);
      }

      var clickCircle;
      var clickMarker;
      function displayCircle(e) {
        if (clickCircle != undefined) { map.removeLayer(clickCircle); };
        if (clickMarker != undefined) { map.removeLayer(clickMarker); };
        clickCircle = L.circle(e.latlng, 1000, { color: '#f07300', fillOpacity: 0.1, opacity: 0.5}).addTo(map);
        clickMarker = L.marker(e.latlng).addTo(map);
      }
    </script>
</body>
</html>
